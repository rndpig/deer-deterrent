# =============================================================================
# Dell OptiPlex All-in-One Deployment
# Deer Deterrent System - Complete Stack
# =============================================================================
# 
# This Docker Compose file runs the entire deer deterrent system on a single
# Dell OptiPlex machine running Ubuntu Server.
#
# Services:
# - Backend: FastAPI server (port 8000)
# - ML Detector: YOLOv8 inference service (port 8001)
  # Coordinator - Orchestrates Ring camera events -> ML detection -> Irrigation activation
# - Database: PostgreSQL (port 5432)
# - MQTT Broker: Mosquitto (port 1883)
# - Ring MQTT: Ring camera integration (port 55123)
# - Frontend: DISABLED - Now hosted on Firebase (https://deer-deterrent-rnp.web.app)
#
# Usage:
#   docker compose up -d
#   docker compose logs -f
#   docker compose down
#
# =============================================================================

services:
  # ===========================================================================
  # Database Service - PostgreSQL
  # ===========================================================================
  database:
    image: postgres:16-alpine
    container_name: deer-db
    restart: unless-stopped
    
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-deer_deterrent}
      - POSTGRES_USER=${POSTGRES_USER:-deeruser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-changeme}
      - PGDATA=/var/lib/postgresql/data/pgdata
      - TZ=${TIMEZONE:-America/New_York}
    
    volumes:
      - ./dell-deployment/data/database:/var/lib/postgresql/data
    
    ports:
      - "5432:5432"
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-deeruser}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    networks:
      - deer-network

  # ===========================================================================
  # MQTT Broker - Mosquitto
  # ===========================================================================
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: deer-mosquitto
    restart: unless-stopped
    
    volumes:
      - ./dell-deployment/mosquitto/config:/mosquitto/config
      - ./dell-deployment/mosquitto/data:/mosquitto/data
      - ./dell-deployment/mosquitto/log:/mosquitto/log
    
    ports:
      - "1883:1883"
      - "9001:9001"
    
    environment:
      - TZ=${TIMEZONE:-America/New_York}
    
    healthcheck:
      test: ["CMD-SHELL", "mosquitto_sub -t '$$SYS/#' -C 1 -i healthcheck -W 3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    networks:
      - deer-network

  # ===========================================================================
  # Ring MQTT Bridge - Connects Ring cameras to MQTT
  # ===========================================================================
  ring-mqtt:
    image: tsightler/ring-mqtt:latest
    container_name: deer-ring-mqtt
    restart: unless-stopped
    
    depends_on:
      mosquitto:
        condition: service_healthy
    
    environment:
      - TZ=${TIMEZONE:-America/New_York}
      - RINGTOKEN=${RING_REFRESH_TOKEN:-}
      - RINGENABLE2FA=${RING_2FA_METHOD:-email}
      - MQTTHOST=mosquitto
      - MQTTPORT=1883
      - MQTTUSER=${MQTT_USER:-}
      - MQTTPASSWORD=${MQTT_PASSWORD:-}
      - ENABLECAMERAS=true
      - ENABLEMODES=true
      - ENABLEPANIC=false
      - SNAPSHOTMODE=all
    
    volumes:
      - ./dell-deployment/ring-mqtt:/data
    
    ports:
      - "8554:8554"   # RTSP streaming (optional)
      - "55123:55123" # Web UI for configuration
    
    networks:
      - deer-network

  # ===========================================================================
  # Backend API - FastAPI Server
  # ===========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: deer-backend
    restart: unless-stopped
    
    group_add:
      - "988"  # Docker group GID for socket access
    
    depends_on:
      database:
        condition: service_healthy
    
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-deeruser}:${POSTGRES_PASSWORD:-changeme}@database:5432/${POSTGRES_DB:-deer_deterrent}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-change-this-secret-key}
      - JWT_ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://${DELL_SERVER_IP:-192.168.1.200}:3000}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TIMEZONE:-America/New_York}
    
    volumes:
      - ./backend:/app
      - ./src:/app/src
      - ./dell-deployment/logs/backend:/app/logs
      - ./dell-deployment/data/snapshots:/app/snapshots:ro
      - ./dell-deployment/models:/app/models
      - ./backend/data:/app/data
      - ./data:/app/project_data
      - ./temp:/app/temp
      - ./configs:/app/configs:ro
      - /var/run/docker.sock:/var/run/docker.sock
    
    ports:
      - "8000:8000"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - deer-network

  # ===========================================================================
  # ML Detector - YOLOv8 Inference Service
  # ===========================================================================
  ml-detector:
    build:
      context: .
      dockerfile: Dockerfile.ml-detector
    container_name: deer-ml-detector
    restart: unless-stopped
    
    environment:
      - YOLO_MODEL_PATH=${YOLO_MODEL_PATH:-/app/models/production/best.pt}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD:-0.30}
      - IOU_THRESHOLD=${IOU_THRESHOLD:-0.45}
      - DEVICE=${DEVICE:-cpu}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TIMEZONE:-America/New_York}
    
    volumes:
      - ./src:/app/src
      - ./dell-deployment/models:/app/models
      - ./dell-deployment/logs/ml-detector:/app/logs
    
    ports:
      - "8001:8001"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Uncomment if you have NVIDIA GPU:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    
    networks:
      - deer-network

  # ===========================================================================
  # Coordinator - Ring Webhook Handler & Irrigation Controller
  # ===========================================================================
  coordinator:
    build:
      context: .
      dockerfile: Dockerfile.coordinator
    container_name: deer-coordinator
    restart: unless-stopped
    
    depends_on:
      mosquitto:
        condition: service_healthy
      ml-detector:
        condition: service_healthy
      backend:
        condition: service_started
    
    environment:
      - ML_DETECTOR_URL=http://ml-detector:8001
      - BACKEND_API_URL=http://backend:8000
      - MQTT_HOST=mosquitto
      - MQTT_PORT=1883
      - MQTT_USER=${MQTT_USER:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - RAINBIRD_IP=${RAINBIRD_IP:-}
      - RAINBIRD_PASSWORD=${RAINBIRD_PASSWORD:-}
      - RAINBIRD_ZONE=${RAINBIRD_ZONE:-1}
      - RAINBIRD_DURATION_SECONDS=${RAINBIRD_DURATION_SECONDS:-30}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD:-0.30}
      - COOLDOWN_SECONDS=${COOLDOWN_SECONDS:-300}
      - ENABLE_IRRIGATION=${ENABLE_IRRIGATION:-true}
      - ACTIVE_HOURS_START=${ACTIVE_HOURS_START:-20}
      - ACTIVE_HOURS_END=${ACTIVE_HOURS_END:-6}
      - ENABLE_PERIODIC_SNAPSHOTS=${ENABLE_PERIODIC_SNAPSHOTS:-false}
      - PERIODIC_SNAPSHOT_INTERVAL=${PERIODIC_SNAPSHOT_INTERVAL:-60}
      - PERIODIC_SNAPSHOT_CAMERAS=${PERIODIC_SNAPSHOT_CAMERAS:-10cea9e4511f,587a624d3fae,4439c4de7a79,f045dae9383a}
      - RING_LOCATION_ID=${RING_LOCATION_ID:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - TZ=${TIMEZONE:-America/New_York}
    
    volumes:
      - ./dell-deployment/logs/coordinator:/app/logs
      - ./dell-deployment/data/snapshots:/app/snapshots
      - ./backend/data:/app/data  # Shared with backend for periodic snapshots
    
    ports:
      - "5000:5000"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    networks:
      - deer-network

  # ===========================================================================
  # Frontend - React/Vite Dashboard
  # ===========================================================================
  # DISABLED: Frontend now hosted on Firebase at https://deer-deterrent-rnp.web.app
  # No need to run locally since external dashboard is accessible via Cloudflare Tunnel
  #
  # frontend:
  #   build:
  #     context: ./frontend
  #     dockerfile: Dockerfile
  #     args:
  #       - VITE_API_URL=http://${DELL_SERVER_IP:-192.168.1.200}:8000
  #       - VITE_DISABLE_AUTH=true
  #   container_name: deer-frontend
  #   restart: unless-stopped
  #   
  #   depends_on:
  #     - backend
  #   
  #   environment:
  #     - TZ=${TIMEZONE:-America/New_York}
  #   
  #   volumes:
  #     - ./frontend/src:/app/src
  #     - ./frontend/public:/app/public
  #   
  #   ports:
  #     - "3000:3000"
  #   
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   
  #   networks:
  #     - deer-network

# =============================================================================
# Networks
# =============================================================================
networks:
  deer-network:
    name: deer-network
    driver: bridge

# =============================================================================
# Volumes (Optional - for named volumes instead of bind mounts)
# =============================================================================
# volumes:
#   postgres_data:
#   mosquitto_data:
#   mosquitto_logs:
#   ring_mqtt_data:
#   app_logs:
#   snapshots:
